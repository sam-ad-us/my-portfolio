/**
 * Core Philosophy:
 * This ruleset supports a public-facing portfolio application.
 * Most content (projects, skills, profiles) is publicly readable.
 * All sensitive write operations are strictly controlled using
 * Role-Based Access Control (RBAC).
 *
 * Data Structure:
 * The database uses a flat structure with the following top-level collections:
 * /projects, /skills, /user_profiles, and /contact_messages.
 * This avoids nested reads and keeps security rules fast and simple.
 *
 * Key Security Decisions:
 * - Admin Role: A single Firebase Auth UID is designated as the administrator.
 *   This user has full write access to content collections.
 * - Public Read-Only Content: Portfolio content is readable by anyone.
 * - Ownership-Based Writes: Users may only modify their own profile document.
 * - Private Drop-Box Pattern: Contact messages can be created by anyone
 *   but are unreadable from the client for privacy and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------
    // Helper Functions
    // --------------------------------------------------

    /**
     * Checks whether a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks whether the authenticated user owns the document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks whether the authenticated user is the administrator.
     * Replace the UID below with the actual admin Firebase Auth UID.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.uid == "emM4KrlWNMR9Vhh7uCMmH5D6t362";
    }

    // --------------------------------------------------
    // Collection Rules
    // --------------------------------------------------

    /**
     * @description
     * Rules for the `projects` collection.
     * Projects are publicly readable but only the admin
     * can create, update, or delete them.
     */
    match /projects/{projectId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description
     * Rules for the `skills` collection.
     * Skills are publicly readable but only the admin
     * can create, update, or delete them.
     */
    match /skills/{skillId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description
     * Rules for the `user_profiles` collection.
     * Profiles are publicly readable.
     * Users may only create or update their own profile document.
     */
    match /user_profiles/{userProfileId} {
      allow read: if true;
      allow write: if isOwner(userProfileId);
    }

    /**
     * @description
     * Rules for the `contact_messages` collection.
     * Acts as a secure "drop-box".
     * Anyone can submit a message.
     * No client is allowed to read, update, or delete messages.
     * Admin access should be handled server-side (Cloud Functions / Admin SDK).
     */
    match /contact_messages/{contactMessageId} {
      allow create: if true;
      allow read, update, delete: if false;
    }
  }
}
